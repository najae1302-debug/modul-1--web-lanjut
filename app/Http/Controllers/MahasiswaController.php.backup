<?php

namespace App\Http\Controllers;

use App\Models\Mahasiswa;
use App\Models\Matakuliah;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class MahasiswaController extends Controller
{
    /**
     * Menampilkan semua data
     */
    public function index(Request $request)
    {
        $search = $request->input('search');
        
        $query = Mahasiswa::query();
        
        if ($search) {
            $query->where(function($q) use ($search) {
                $q->where('nim', 'LIKE', "%{$search}%")
                  ->orWhere('nama', 'LIKE', "%{$search}%")
                  ->orWhere('kelas', 'LIKE', "%{$search}%")
                  ->orWhere('matakuliah', 'LIKE', "%{$search}%");
            });
        }
        
        $mahasiswas = $query->latest()->paginate(10);
        
        return view('mahasiswa.index', compact('mahasiswas', 'search'));
    }

    /**
     * Menampilkan form create
     */
    public function create()
    {
        $matakuliahs = Matakuliah::orderBy('kode_mk')->get();
        return view('mahasiswa.create', compact('matakuliahs'));
    }

    /**
     * Menyimpan data baru
     */
    public function store(Request $request)
    {
        $request->validate([
            'nim' => 'required|unique:mahasiswas,nim|max:20',
            'nama' => 'required|max:100',
            'kelas' => 'required|max:10',
            'matakuliah' => 'required|max:100',
            'kode_mk' => 'nullable|exists:matakuliahs,kode_mk'
        ], [
            'nim.required' => 'NIM wajib diisi',
            'nim.unique' => 'NIM sudah terdaftar',
            'nama.required' => 'Nama wajib diisi',
            'kelas.required' => 'Kelas wajib diisi',
            'matakuliah.required' => 'Mata kuliah wajib diisi'
        ]);

        $data = $request->all();
        $data['kode_mk'] = $request->kode_mk ?? null;
        
        Mahasiswa::create($data);
        
        return redirect()->route('mahasiswa.index')
            ->with('success', 'Data mahasiswa berhasil ditambahkan!');
    }

    /**
     * Menampilkan detail (opsional)
     */
    public function show($nim)
    {
        $mahasiswa = Mahasiswa::findOrFail($nim);
        return view('mahasiswa.show', compact('mahasiswa'));
    }

    /**
     * Menampilkan form edit
     */
    public function edit($nim)
    {
        $mahasiswa = Mahasiswa::findOrFail($nim);
        $matakuliahs = Matakuliah::orderBy('kode_mk')->get();
        return view('mahasiswa.edit', compact('mahasiswa', 'matakuliahs'));
    }

    /**
     * Update data
     */
    public function update(Request $request, $nim)
    {
        $request->validate([
            'nama' => 'required|max:100',
            'kelas' => 'required|max:10',
            'matakuliah' => 'required|max:100',
            'kode_mk' => 'nullable|exists:matakuliahs,kode_mk'
        ], [
            'nama.required' => 'Nama wajib diisi',
            'kelas.required' => 'Kelas wajib diisi',
            'matakuliah.required' => 'Mata kuliah wajib diisi'
        ]);

        $mahasiswa = Mahasiswa::findOrFail($nim);
        $mahasiswa->update($request->all());
        
        return redirect()->route('mahasiswa.index')
            ->with('success', 'Data mahasiswa berhasil diperbarui!');
    }

    /**
     * Hapus data
     */
    public function destroy($nim)
    {
        $mahasiswa = Mahasiswa::where('nim', $nim)->first();
        
        if ($mahasiswa) {
            $mahasiswa->delete();
            return redirect()->route('mahasiswa.index')
                ->with('success', 'Data mahasiswa berhasil dihapus!');
        }
        
        return redirect()->route('mahasiswa.index')
            ->with('error', 'Data tidak ditemukan');
    }
}